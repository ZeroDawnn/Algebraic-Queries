<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>FABRIC - Geometric Shapes</title>
	<meta content="FABRIC - Geometric Shapes" name="description">
	<meta content="rtai" name="author">
	<meta content="html, css, js" name="keywords">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
	<script src="librairies/fabric.js-master/dist/fabric.min.js" type="text/javascript"></script>
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
	<style type="text/css">
		body{
			margin:auto;
			width:80%;
			overflow: hidden;
			font-family: 'Roboto', sans-serif;
		}
		/*#canvas{
			width:800px;
			border:1px solid #003399;
		}*/
		select{
			font-family: 'Roboto', sans-serif;
			margin-bottom: 10px;
		}
		input[type='button']{
			font-family: 'Roboto', sans-serif;
			display: block;
			text-transform: uppercase;
			width: 75px;
			margin: 20px auto;
		}
		form{
			width: 450px;
			margin: 20px auto;
		}
		#implement{
			position: absolute;
			display: none;
			top: 50%;
			left: 300px;
			width: 500px;
			height: 150px;
			background-color: white;
			box-shadow: 2px 2px 20px 0px rgba(0,0,0,0.6);
		}
	</style>
</head>
<body>
	<h1>FABRIC JS - Canvas</h1>
	<button id="copy" onclick="Copy()">Copy</button>
	<button id="paste" onclick="Paste()">Paste</button>
	<button id="delete" onclick="Delete()">Delete</button>
	|
	<button id="zoomIn" onclick="ZoomIn()">Zoom in</button>
	<button id="zoomOut" onclick="ZoomOut()">Zoom out</button>
	<button id="zoomReset" onclick="ResetZoom()">Reset zoom</button>
	<br><br>
	<button id="selectObject" onclick="createSelectObject()">Select</button>
	<button id="fromObject" onclick="createFromObject()">From</button>
	<button id="whereObject" onclick="createWhereObject()">Where</button>
	<button id="joinObject" onclick="createJoinObject()">Join</button>
	|
	<button id="chooseMode" onclick="chooseMode()">Selection/Drawing mode</button>
	<button id="clear" onclick="clearCanvas()">Clear board</button>
	<button id="grid" onclick="showHideGrid()">Show/Hide grid</button>
	<button id="child" onclick="addChild()">Add Child</button>
	<button onclick="implement()">Implement</button>
	<!-- <p id="oui"></p> -->
	<br><br>
	<canvas id="canvas" style="border:1px solid #003399"></canvas>		
	<div id="implement"></div>

	<script type="text/javascript">			
		//zoom
		var SCALE_FACTOR = 1.1;
		function ZoomIn() {
			canvas.setZoom(canvas.getZoom()*SCALE_FACTOR);
    		canvas.renderAll();
		}

		function ZoomOut() {
			canvas.setZoom(canvas.getZoom()/SCALE_FACTOR);
    		canvas.renderAll();
		}

		function ResetZoom() {
			canvas.setZoom(1);
    		canvas.renderAll();
		}	

		//delete
		function Delete(){
		    if (canvas.getActiveObject().get('type')!=='group') {
		        if (confirm('delete object ?')) {
		            //canvas.remove(canvas.getActiveObject());
		            var objects = canvas.getActiveObject().getObjects();
		            for (let i in objects) {
		            	canvas.remove(objects[i]);
		            }
		            canvas.discardActiveObject();
		        }
		    }
		    else if (canvas.getActiveObject().get('type')==='group') {
		        if (confirm('delete group ?')) {		      
		            canvas.remove(canvas.getActiveObject());
		            canvas.discardActiveObject();
		        }
		    }

		}

		function chooseMode() {
			if(canvas.isDrawingMode===false){
				canvas.isDrawingMode=true;
			}
			else{
				canvas.isDrawingMode=false;
			}
		}	

		function clearCanvas() {
			var objects = canvas.getObjects();
			while(objects.length !== 0){
	  				canvas.remove(objects[0]);
			}
			drawGrid();		  			
		}

		function showHideGrid() {
			var objects = canvas.getObjects('line');
			if(objects.length===0){
				drawGrid();
			}
			else{				
			    for (let i in objects) {
			        canvas.remove(objects[i]);
			    }
			    RenderCanvas();
			}
		}

		//copy paste objects
		function Copy() {
			// clone what are you copying since you
			// may want copy and paste on different moment.
			// and you do not want the changes happened
			// later to reflect on the copy.
			canvas.getActiveObject().clone(function(cloned) {
				_clipboard = cloned;
			});
		}

		function Paste() {
			// clone again, so you can do multiple copies.
			_clipboard.clone(function(clonedObj) {
				canvas.discardActiveObject();
				clonedObj.set({
					left: clonedObj.left + 20,
					top: clonedObj.top + 20,
					evented: true,
				});
				if (clonedObj.type === 'activeSelection') {
					// active selection needs a reference to the canvas.
					clonedObj.canvas = canvas;
					clonedObj.forEachObject(function(obj) {
						canvas.add(obj);
					});
					// this should solve the unselectability
					clonedObj.setCoords();
				} else {
					canvas.add(clonedObj);
				}
				_clipboard.top += 20;
				_clipboard.left += 20;
				canvas.setActiveObject(clonedObj);
				canvas.requestRenderAll();
			});
		}

		createListenersKeyboard();
		function createListenersKeyboard() {
		    document.onkeydown = onKeyDownHandler;
		    //document.onkeyup = onKeyUpHandler;
		}

		function onKeyDownHandler(event) {
		    //event.preventDefault();
		    var key;
		    if(window.event){
		        key = window.event.keyCode;
		    }
		    else{
		        key = event.keyCode;
		    }
		    
		    switch(key){
		        // Shortcuts
		        case 67: // Ctrl+C
		            if(event.ctrlKey){
		                event.preventDefault();
		                Copy();
		            }
		            break;
		        // Paste (Ctrl+V)
		        case 86: // Ctrl+V
		            if(event.ctrlKey){
		                event.preventDefault();
		                Paste();
		            }
		            break;	
		        case 46:
		        	Delete();
		        	break;		       	
		       	case 35:
		       		OriginalZoom();
		       		break;            
		        default:
		            // TODO
		            break;
		    }
		}	

		//create canvas			
		var canvas = this.__canvas = new fabric.Canvas('canvas',{selection:true, isDrawingMode:false, height:700, width:1000}), options = {distance:10, width:canvas.width, 
			height:canvas.height, param: {stroke:'#ebebeb', strokeWidth:1, selectable:false}}, gridLen = options.width / options.distance;
  
  		//draw grid (line h&v)
  		function drawGrid() {
  			for (var i = 0; i < gridLen; i++) {
			  	var distance   = i * options.distance,
			      	horizontal = new fabric.Line([ distance, 0, distance, options.width], options.param),
			        vertical   = new fabric.Line([ 0, distance, options.width, distance], options.param);
			   	canvas.add(horizontal);
			   	canvas.add(vertical);
			   	canvas.sendToBack(horizontal);
			   	canvas.sendToBack(vertical);
			   	if(i%5 === 0){
			   		horizontal.set({stroke: '#cccccc'});
			      	vertical.set({stroke: '#cccccc'});
			   	};
			};
  		}

  		drawGrid();

  		var id_generate=0;
  		
  		var polySelect=[];
  		var indexS = 0;
  		function createSelectObject() {
  			polySelect[indexS] = new fabric.Path('M10 30L40 80L120 80L150 30z');
  			polySelect[indexS].set({left:500, top:100, fill:'orange', stroke:'black', name:'select'});
  			canvas.add(polySelect[indexS]);
  			indexS++;
  		}

  		var circleFrom=[];
  		var indexF=0;
  		function createFromObject() {
  			circleFrom[indexF] = new fabric.Circle({radius:50, fill:'red', left:50, top:50, stroke:'black', name:'from'});
  			canvas.add(circleFrom[indexF]);
  			indexF++;
  		}	

  		var polyWhere=[];
  		var indexW=0;
  		function createWhereObject() {
  			polyWhere[indexW] = new fabric.Path('M10 30L10 120L110 90L110 60z');
  			polyWhere[indexW].set({left:100, top:100, fill:'green', stroke:'black', name:'where'});
  			canvas.add(polyWhere[indexW]);
  			indexW++;
  		}	

  		var polyJoin=[];
  		var indexJ=0;
  		function createJoinObject() {
  			polyJoin[indexJ] = new fabric.Path('M10 30L10 80L60 30L60 80z');
  			polyJoin[indexJ].set({left:200, top:50, fill:'blue', stroke:'black', name:'join'});
  			canvas.add(polyJoin[indexJ]);
  			indexJ++;
  		}		

		canvas.on('mouse:wheel', function (options){
			if(options.e.deltaY<0){
				ZoomIn();
			}	
			else if(options.e.deltaY>0){
				ZoomOut();
			}
		});

		/*circle1 = new fabric.Circle({radius:50, fill:'red', left:50, top:150, stroke:'black'});
		circle2 = new fabric.Circle({radius:50, fill:'red', left:50, top:250, stroke:'black'});
		circle3 = new fabric.Circle({radius:50, fill:'red', left:50, top:350, stroke:'black'});
		circle4 = new fabric.Circle({radius:50, fill:'red', left:50, top:450, stroke:'black'});
		var group=new fabric.Group([circle1,circle2,circle3,circle4]);
		canvas.add(group);

		canvas.renderAll();		*/
		//panning


		// Fonction pour créer une ligne
		function makeLine(coords) {
		    return new fabric.Line(coords, {
		        fill: 'black',
		        stroke: 'black',
		        strokeWidth: 1,
		        selectable: false
		    });
		}

		function updateSelect() {
				var option = $('#select_table option:selected').val();
				$('#select_columns').html('');
				$.ajax({
					url: 'traitement_test.php',
					type: 'GET',
					data: 'select_table=' + option,
					dataType: 'JSON',
					success : function(data){
						var tab = JSON.parse(data);
						for(var i = 0; i < tab.length; i++){
							$("#select_columns").append('<option value="'+ tab[i].column_name +'">' + tab[i].column_name + '</option>');
						}
					},
					error : function(){
						alert('Erreur');
       				}
				});
		}

		// Pour créer un lien entre formes
		// On selectionne la première forme
		// Ensuite, on clique sur "Add Child"
		// On déselectionne le premier objet
		// On séléectionne le second objet à lier
		var selectedElement = null;
		var links = new Array();

		canvas.on('object:selected', function(options) {
		    if (canvas.connect) {
		        canvas.connect = false;
		        var from = selectedElement;
		        var to = options.target;
		        links[from] = new Array(to);
		        alert(links[from][0]);
		        var from_coord = from.getCenterPoint();
		        var to_coord = to.getCenterPoint()
		        var line = makeLine([from_coord.x, from_coord.y, to_coord.x, to_coord.y]);
	          	canvas.add(line);
	           	
	           	selectedElement.moveLine = function() {
	               var from = selectedElement.getCenterPoint();
	               line.set({ 'x1': from_coord.x, 'y1': from_coord.y });
	           	};
	           	options.target.moveLine = function() {
	               var to = options.target.getCenterPoint();
	               line.set({ 'x2': to_coord.x, 'y2': to_coord.y });
	           	};
		    }
		    if (canvas.implement){
		    	canvas.implement = false;
		    	if(selectedElement.name == 'select'){
		    		$("#implement").append('<form>SELECT IN TABLE <select id="select_table"></select><br> THE VALUE <select id="select_columns"></select><input type="button" value="valider"></form>');
		    		$("#implement").show();
		    		$.ajax({
						url: 'traitement_test.php',
						type: 'GET',
						dataType: 'JSON',
						success : function(data){
							var tab = JSON.parse(data);
							for(var i = 0; i < tab.length; i++){
								$("#select_table").append('<option value="'+ tab[i].table_name.toUpperCase() +'">' + tab[i].table_name.toUpperCase() + '</option>');
							}
							updateSelect();
						},
						error : function(){
							alert('Erreur');
	       				}
					});
					$("#select_table").change(function(){
		    			updateSelect();
		    		});
		    	}
		    }
			selectedElement = options.target;
		});
		
		// Pour faire suivre le trait lors du déplacement des formes
		canvas.on('object:moving', function(e) {
		    e.target.moveLine();
		    canvas.renderAll();
		});


		window.addChild = function() {
		   canvas.connect = true;
		}

		window.implement = function(){
			canvas.implement = true;
		}


	</script>
</body>
</html>