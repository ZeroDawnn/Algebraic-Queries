<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Test options</title>
	<link rel="stylesheet" href="librairies/bootstrap-4.0.0-dist/css/bootstrap.min.css" type="text/css">
	<script defer src="librairies/fontawesome-free-5.0.6/on-server/js/fontawesome-all.min.js"></script>
	<script src="librairies/jquery-3.3.1.min.js"></script>
	<script src="librairies/popper.min.js" type="text/javascript"></script>
	<script src="librairies/svg.min.js" type="text/javascript"></script>
	<script src="librairies/bootstrap-4.0.0-dist/js/bootstrap.min.js" type="text/javascript"></script>
	<script src="librairies/interact.min.js" type="text/javascript"></script>
	<style>
	body {
		margin: 0 ;
		padding:0 ;
	}
	#outer-dropzone {
		height: 140px;
	}

	#inner-dropzone {
		height: 180px;
	}

	.delete {
		background-color: #ccc;
		border: dashed 4px transparent;
		border-radius: 4px;
		margin: 10px auto 30px;
		padding: 10px;
		width: 80%;
		transition: background-color 0.3s;
	}

	.copy {
		background-color: #ccc;
		border: dashed 4px transparent;
		border-radius: 4px;
		margin: 10px auto 30px;
		padding: 10px;
		width: 80%;
		transition: background-color 0.3s;
	}

	.drop-active {
		border-color: #aaa;
	}

	.drop-target {
		background-color: #29e;
		border-color: #fff;
		border-style: solid;
	}

	.drag-drop {
		display: inline-block;
		min-width: 40px;
		padding: 2em 0.5em;

		color: #fff;
		background-color: #29e;
		border: solid 2px #fff;

		-webkit-transform: translate(0px, 0px);
		transform: translate(0px, 0px);

		transition: background-color 0.3s;
	}

	.drag-drop.can-drop {
		color: #000;
		background-color: #4e4;
	}

	/*#drawing {
		width:100%;
		background-color: #444;
	}*/

	#options {
		position: absolute;
		top:2%;
		right:3%;
	}

	#grille {
		position: absolute;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		z-index: -1;
	}
	</style>
</head>
<body>
	<div id="grille">
		<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
			<defs>
				<pattern id="smallGrid" width="6" height="6" patternUnits="userSpaceOnUse">
					<path d="M 6 0 L 0 0 0 6" fill="none" stroke="gray" stroke-width="0.5"></path>
				</pattern>
				<pattern id="grid" width="60" height="60" patternUnits="userSpaceOnUse">
					<rect width="60" height="60" fill="url(#smallGrid)"></rect>
					<path d="M 60 0 L 0 0 0 60" fill="none" stroke="gray" stroke-width="1"></path>
				</pattern>
			</defs>
			<rect width="100%" height="100%" fill="url(#grid)"></rect>
		</svg>
	</div>
	<div id="drawing">
		<div id="select1" class="draggable drag-drop click_target" data-type="select" data-click="false"> #select1 </div>
		<div id="from1" class="draggable drag-drop click_target" data-type="from" data-click="false"> #from1 </div>
		<div id="where1" class="draggable drag-drop click_target" data-type="where" data-click="false"> #where1 </div>

		<div id="inner-dropzone" class="delete">#delete-dropzone</div>
		<!-- <div id="inner-dropzone" class="copy">#copy-dropzone</div> -->		
	</div>

	<div id="options">
		<input type="submit" id="zoomIn" value="zoom +">
		<input type="submit" id="zoomOut" value="zoom -">
		<input type="submit" id="zoomReset" value="zoom =">
		<input type="submit" id="delete" value="delete">
		<input type="submit" id="clear" value="delete all">
	</div>

	<script>
	$(document).ready(function() {
		var nbSelect = 1;
		var nbFrom = 1;
		var nbWhere = 1;
		var coefZoom = 1.0;
		var nbDraggableClicked = 0;

		$('#drawing').css('zoom', coefZoom);
		$('#select1').css('border', '3px dashed transparent');
		$('#from1').css('border', '3px dashed transparent');
		$('#where1').css('border', '3px dashed transparent');

		$('#zoomIn').click(function() {
			if(coefZoom < 2.5) {
				coefZoom += 0.2;
				$('#drawing').css('zoom', coefZoom);
				$('#grille').css('zoom', coefZoom);
			}
			else {
				alert('zoom + max atteint');
			}			
		});

		$('#zoomOut').click(function() {
			if(coefZoom > 0.5) {
				coefZoom -= 0.2;
				$('#drawing').css('zoom', coefZoom);
				$('#grille').css('zoom', coefZoom);
			}
			else {
				alert('zoom - max atteint');
			}
		});

		$('#zoomReset').click(function() {
			coefZoom = 1.0;
			$('#drawing').css('zoom', coefZoom);
			$('#grille').css('zoom', coefZoom);
		});

		$('#clear').click(function() {
			$('.draggable').each(function() {
				$(this).remove();
			})
		});

		$('#delete').click(function() {							
			$('.draggable').each(function() {
				if($(this).attr('data-click') == 'true') {
					if(confirm('sure to delete ?')) {
						$(this).remove();
					}					
				}
			});					
		});

		// $('#grille').click(function() {//works if #grille isn't z-index:-1
		// 	$('.draggable').each(function() {
		// 		console.log($(this));
		// 		if($(this).attr('data-click') == 'true') {
		// 			$(this).css('border', '3px dashed transparent');
		// 			$(this).attr('data-click', 'false');
		// 		}				
		// 	})
		// });

		//----------------------------------------------------------------
		//drop delete
		//----------------------------------------------------------------
		interact('.delete').dropzone({
			// only accept elements matching this CSS selector
			accept: ['#select1', '#from1', '#where1'],
			// Require a 75% element overlap for a drop to be possible
			overlap: 0.75,

			// listen for drop related events:

			ondropactivate: function (event) {
				// add active dropzone feedback
				event.target.classList.add('drop-active');
			},
			ondragenter: function (event) {
				var draggableElement = event.relatedTarget,
				dropzoneElement = event.target;

				// feedback the possibility of a drop
				dropzoneElement.classList.add('drop-target');
				draggableElement.classList.add('can-drop');
				//draggableElement.textContent = 'Dragged in';

			},
			ondragleave: function (event) {
				// remove the drop feedback style
				event.target.classList.remove('drop-target');
				event.relatedTarget.classList.remove('can-drop');
				//event.relatedTarget.textContent = 'Dragged out';
			},
			ondrop: function (event) {
				//event.relatedTarget.textContent = 'Dropped';
				if(confirm('sure to remove ?')) {
					var type = event.relatedTarget.getAttribute('data-type');
					event.relatedTarget.remove();
					if(type == 'select')
						nbSelect--;
					else if(type == 'from')
						nbFrom--;
					else if(type == 'where')
						nbWhere--;
				}
				else {
					var posX = parseFloat(event.relatedTarget.getAttribute('data-x'));
					var posY = parseFloat(event.relatedTarget.getAttribute('data-y'));

					event.relatedTarget.style.webkitTransform =
					event.relatedTarget.style.transform =
					'translate(' + (posX-posX) + 'px, ' + (posY-posY) + 'px)';

					event.relatedTarget.setAttribute('data-x', posX-posX);
					event.relatedTarget.setAttribute('data-y', posY-posY);
					event.relatedTarget.classList.remove('can-drop');
				}
			},
			ondropdeactivate: function (event) {
				// remove active dropzone feedback
				event.target.classList.remove('drop-active');
				event.target.classList.remove('drop-target');
			}
		});

		//----------------------------------------------------------------
		//drop clone
		//----------------------------------------------------------------
		/*interact('.copy').dropzone({
			// only accept elements matching this CSS selector
			accept: ['#select1', '#from1'],
			// Require a 75% element overlap for a drop to be possible
			overlap: 0.75,

			// listen for drop related events:

			ondropactivate: function (event) {
				// add active dropzone feedback
				event.target.classList.add('drop-active');
			},
			ondragenter: function (event) {
				var draggableElement = event.relatedTarget,
				dropzoneElement = event.target;

				// feedback the possibility of a drop
				dropzoneElement.classList.add('drop-target');
				draggableElement.classList.add('can-drop');
				//draggableElement.textContent = 'Dragged in';
			},
			ondragleave: function (event) {
				// remove the drop feedback style
				event.target.classList.remove('drop-target');
				event.relatedTarget.classList.remove('can-drop');
				//event.relatedTarget.textContent = 'Dragged out';
			},
			ondrop: function (event) {
				//event.relatedTarget.textContent = 'Dropped';

				var original = event.relatedTarget,
				// create a clone of the currentTarget element
				clone = event.relatedTarget.cloneNode(true);

				// insert the clone to the page
				// TODO: position the clone appropriately
				$('#drawing').append(clone);
				clone.classList.remove('can-drop');
				original.classList.remove('can-drop');

				var type = event.relatedTarget.getAttribute('data-type');
				if(type == 'select') {
					nbSelect++;
					clone.setAttribute('id', type+nbSelect);
					var attrId = clone.getAttribute('id');
					$('#'+attrId).text('#'+type+nbSelect);
				}
				else if(type == 'from') {
					nbFrom++;
					clone.setAttribute('id', type+nbFrom);
					var attrId = clone.getAttribute('id');
					$('#'+attrId).text('#'+type+nbFrom);
				}

				//move original
				var posXOrigin = parseFloat(original.getAttribute('data-x'));
				var posYOrigin = parseFloat(original.getAttribute('data-y'));

				original.style.webkitTransform =
				original.style.transform =
				'translate(' + (posXOrigin-posXOrigin) + 'px, ' + (posYOrigin-posYOrigin) + 'px)';

				original.setAttribute('data-x', posXOrigin-posXOrigin);
				original.setAttribute('data-y', posYOrigin-posYOrigin);

				//move clone
				clone.style.webkitTransform =
				clone.style.transform =
				'translate(' + 0 + 'px, ' + 0 + 'px)';

				clone.setAttribute('data-x', 0);
				clone.setAttribute('data-y', 0);
			},
			ondropdeactivate: function (event) {
				// remove active dropzone feedback
				event.target.classList.remove('drop-active');
				event.target.classList.remove('drop-target');
			}
		});*/

		//----------------------------------------------------------------
		//drag
		//----------------------------------------------------------------
		var element = $('#grille'),
    		x = 0, y = 0;

		interact('.draggable')
		.draggable({
			snap: {
				targets: [
			    	interact.createSnapGrid({ x: 40, y: 40 })
			    ],
			      range: Infinity,
			      relativePoints: [ { x: 0, y: 0 } ]
			},
			// enable inertial throwing
			inertia: true,
			// keep the element within the area of it's parent
			restrict: {
				restriction: element.parentNode,
				endOnly: true,
				elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
			},
			// enable autoScroll
			autoScroll: true,

			// call this function on every dragmove event
			onmove: dragMoveListener,
			// call this function on every dragend event
			onend: function (event) {
				var textEl = event.target.querySelector('p');

				textEl && (textEl.textContent =
					'moved a distance of '
					+ (Math.sqrt(Math.pow(event.pageX - event.x0, 2) +
					Math.pow(event.pageY - event.y0, 2) | 0))
					.toFixed(2) + 'px');

				$(event.target).css('border', '3px dashed transparent');
				event.target.setAttribute('data-click', 'true');
			}
		})
		.on('click', function (event) {	
			if(event.target.getAttribute('data-click') == 'true') {
				$(event.target).css('border', '3px dashed transparent');
				event.target.setAttribute('data-click', 'false');
			}
			else {
				$('.draggable').each(function() {
					if($(this).attr('data-click') == 'true') {
						$(this).css('border', '3px dashed transparent');
						$(this).attr('data-click', 'false');
					}
				});

				event.target.setAttribute('data-click', 'true');
				$(event.target).css('border', '3px dashed red');
			}
		});

		function dragMoveListener (event) {
			var target = event.target,
			// keep the dragged position in the data-x/data-y attributes
			x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
			y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

			// translate the element
			target.style.webkitTransform =
			target.style.transform =
			'translate(' + (x/coefZoom) + 'px, ' + (y/coefZoom) + 'px)';

			// update the posiion attributes
			target.setAttribute('data-x', x);
			target.setAttribute('data-y', y);

			$('.draggable').each(function() {
				if($(this).attr('data-click') == 'true') {
					$(this).css('border', '3px dashed transparent');
					$(this).attr('data-click', 'false');
				}
			});

			$(event.target).css('border', '3px dashed red');			
		}

		// this is used later in the resizing and gesture demos
		window.dragMoveListener = dragMoveListener;
	});
	</script>
</body>
</html>
